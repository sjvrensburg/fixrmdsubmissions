# CRUSH.md

This file provides guidance to agents working with the `fixrmdsubmissions` R package.

## Package Overview

`fixrmdsubmissions` is an R package that automatically fixes common issues in student R Markdown submissions so instructors can grade hundreds of files reliably. The package processes broken `.Rmd` files by evaluating code chunks sequentially, adding `eval = FALSE` to failing chunks, and converting bare file paths to portable `here::here()` calls.

## Development Commands

### Essential Workflow
```r
# Load package for development (most common)
devtools::load_all()

# Run test suite (comprehensive - 54 tests)
devtools::test()

# Generate documentation from roxygen2 comments
devtools::document()

# Check package (validates structure, dependencies, etc.)
devtools::check()

# Install package locally for testing
devtools::install()

# Build source package
devtools::build()
```

### Testing Commands
```r
# Run all tests
devtools::test()

# Run specific test file
devtools::test(filter = "fix-rmd")

# Run tests with detailed output
testthat::test_dir("tests/testthat")
```

## Project Structure

### Core Package Files
- `R/fix_rmd.R` - Main function for fixing individual R Markdown files
- `R/fix_folder.R` - Batch processing function for folders of submissions
- `R/knit_fixed_files.R` - Function to knit all fixed files according to their YAML
- `R/utils-paths.R` - Internal utilities for path fixing logic
- `DESCRIPTION` - Package metadata and dependencies
- `NAMESPACE` - Exported functions (generated by roxygen2)

### Test Structure
- `tests/testthat/` - 54 comprehensive tests covering:
  - Path fixing logic (9 tests)
  - Single file processing (13 tests)  
  - Folder batch processing (7 tests)
  - Realistic grading workflows (6 tests)
  - Output limiting and edge cases

### Example Data
- `inst/extdata/` - Example broken R Markdown files for testing and documentation

## Core Functionality

### Main Exported Functions
1. `fix_rmd()` - Fix individual R Markdown files
2. `fix_folder()` - Batch process entire folders
3. `knit_fixed_files()` - Knit all fixed files respecting YAML settings

### Key Features
- **Sequential chunk evaluation** - Tests each code chunk in a shared environment
- **Intelligent path fixing** - Converts bare filenames to `here::here()` calls
- **Selective disabling** - Only adds `eval = FALSE` to chunks that actually fail
- **Output limiting** - Prevents massive data dumps from breaking documents
- **Transparency** - All modifications are documented with explanatory comments
- **Backup creation** - Always creates `.bak` files before modification

## Code Patterns and Conventions

### Function Documentation
- All exported functions use roxygen2 documentation with markdown format
- Parameters are thoroughly documented with examples
- Functions return invisible file paths for programmatic use
- Error handling uses `stop()` with `call. = FALSE` for cleaner messages

### Internal Functions
- Helper functions are marked with `@keywords internal` and `@noRd`
- Internal function names use snake_case with descriptive prefixes
- Path fixing logic is centralized in `utils-paths.R`

### Error Handling
- Input validation at function start (file existence, .Rmd extension)
- Try-catch blocks for code evaluation with clear error messages
- Graceful handling of missing optional dependencies (here, pander)

## Testing Approach

### Test Patterns
- Each test creates temporary files with `on.exit(unlink(...))` for cleanup
- Tests use `tempfile(fileext = ".Rmd")` to avoid file system dependencies
- Expectations use `testthat` verbs: `expect_true()`, `expect_error()`, etc.
- Conditional tests with `skip_if_not_installed()` for optional dependencies

### Test Coverage
- Unit tests for individual functions and edge cases
- Integration tests for realistic grading workflows
- Tests verify both success and failure scenarios
- Performance tests with realistic student submission examples

## Dependencies

### Required Dependencies
- None (core R functionality only)

### Suggested Dependencies
- `here` - Required for path fixing functionality
- `pander` - Used for table formatting when limiting output
- `rmarkdown` - For knitting functionality
- `testthat` - Development and testing
- `devtools` - Development workflow

### Dependency Management
- Functions check for optional dependencies using `requireNamespace()`
- Clear error messages guide users to install missing packages
- Functions work without optional dependencies when features are disabled

## Important Gotchas

### Path Fixing Logic
The path fixing is intentionally conservative and only modifies:
- Bare filenames in recognized import functions
- Simple relative paths (no `../` parent references)
- Files that don't already use `here::here()`

It never modifies:
- Full-line comments
- Absolute paths, URLs, or network paths
- Existing `here::here()` calls
- Strings outside import function contexts

### Chunk Evaluation Strategy
- Chunks are evaluated sequentially in a shared environment
- Successfully evaluated chunks build on each other
- Failed chunks get `eval = FALSE` added to preserve code structure
- Empty chunks and comment-only chunks are skipped safely

### Output Limiting
- Uses `options(max.print = ...)` and `pander` settings when available
- Limits are applied temporarily and restored automatically
- Default is 100 print lines but configurable

### File Naming Conventions
- Fixed files get `_FIXED.Rmd` suffix
- Backups get `.bak` extension
- Original files are never modified unless `backup = FALSE`

## Development Workflow

### Making Changes
1. Load package with `devtools::load_all()`
2. Make changes to R functions
3. Run `devtools::test()` to verify no regressions
4. Update roxygen2 comments if needed
5. Run `devtools::document()` to update documentation
6. Run `devtools::check()` to validate package

### Adding New Functions
1. Add function to appropriate R file in `R/`
2. Add comprehensive roxygen2 documentation
3. Add tests in `tests/testthat/` following existing patterns
4. Add to NAMESPACE exports if needed
5. Update DESCRIPTION if new dependencies required

### Debugging Tips
- Use `quiet = FALSE` in functions to see detailed processing
- Check temporary files in `/tmp/` if test cleanup fails
- Use `browseURL()` on generated HTML files to verify output
- Check `.here` file exists when testing path fixing

## Package State

This is a mature, well-tested package ready for production use:
- 54 comprehensive tests
- Complete documentation with realistic examples
- Real-world testing with actual student submissions
- Performance optimized for processing hundreds of files
- Academic integrity features with transparency comments

The package follows R package development best practices and has been validated with `devtools::check()`.